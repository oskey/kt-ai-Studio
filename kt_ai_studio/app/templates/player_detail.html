{% extends "base.html" %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Breadcrumb & Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0 small">
                <li class="breadcrumb-item"><a href="/projects" class="text-decoration-none text-secondary">项目列表</a></li>
                <li class="breadcrumb-item"><a href="/projects/{{ player.project_id }}" class="text-decoration-none text-secondary">项目详情</a></li>
                <li class="breadcrumb-item active fw-medium text-dark">{{ player.player_name }}</li>
            </ol>
        </nav>
        
        <div class="d-flex align-items-center gap-2">
            <span class="text-secondary small">状态:</span>
            {% if player.status == 'done' %}
            <span class="badge bg-success-subtle text-success rounded-pill">完成</span>
            {% elif player.status == 'draft' %}
            <span class="badge bg-secondary-subtle text-secondary rounded-pill">草稿</span>
            {% else %}
            <span class="badge bg-warning-subtle text-warning-emphasis rounded-pill">{{ player.status }}</span>
            {% endif %}
        </div>
    </div>

    <div class="row g-4">
        <!-- Left Column: Settings & Actions -->
        <div class="col-lg-4">
            <!-- Player Info Card -->
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="app-avatar me-3 {% if player.player_sex == 'female' %}female{% else %}male{% endif %}" style="width: 40px; height: 40px;">
                            <i class="bi bi-person-fill"></i>
                        </div>
                        <div>
                            <h6 class="fw-bold mb-0">{{ player.player_name }}</h6>
                            <small class="text-secondary">{{ player.player_sex }}</small>
                        </div>
                    </div>
                    <div class="p-3 bg-light rounded-3 small text-secondary">
                        {{ player.player_mark or '无备注' }}
                    </div>
                </div>
            </div>

            <!-- Prompts Card -->
            <div class="card mb-3">
                <div class="card-header bg-white border-bottom-0 pt-3 pb-0">
                    <h6 class="fw-bold mb-0"><i class="bi bi-chat-text me-2 text-primary"></i>提示词 & 特征</h6>
                </div>
                <div class="card-body">
                    <form action="/players/{{ player.id }}/update_prompts" method="post">
                        <div class="mb-3">
                            <label class="text-label mb-1 text-primary">人物特征描述 (合成用)</label>
                            <textarea name="player_desc" class="form-control form-control-sm bg-light border-0" rows="3" placeholder="生成提示词后自动填充，用于后续视频/合成...">{{ player.player_desc or '' }}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="text-label mb-1 text-success">正向提示词 (基图)</label>
                            <textarea name="prompt_pos" class="form-control form-control-sm bg-light border-0" rows="5">{{ player.prompt_pos or '' }}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="text-label mb-1 text-danger">反向提示词</label>
                            <textarea name="prompt_neg" class="form-control form-control-sm bg-light border-0" rows="3">{{ player.prompt_neg or '' }}</textarea>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-sm btn-outline-primary flex-grow-1 rounded-pill" {% if is_generating %}disabled{% endif %}>
                                <i class="bi bi-check-lg me-1"></i>保存修改
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger rounded-pill" 
                                    title="清空所有配置和生成图"
                                    onclick="showClearModal()"
                                    {% if is_generating %}disabled{% endif %}>
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </form>
                    <form id="clear-config-form" action="/players/{{ player.id }}/clear_config" method="post" style="display:none;"></form>
                </div>
            </div>

            <!-- Actions Card -->
            <div class="card mb-3">
                <div class="card-header bg-white border-bottom-0 pt-3 pb-0 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0"><i class="bi bi-lightning-charge me-2 text-primary"></i>生成操作</h6>
                </div>
                <div class="card-body">
                    <!-- One Click Button -->
                    <div class="mb-4">
                         <button type="button" class="btn btn-primary w-100 py-2 rounded-pill shadow-sm fw-bold" 
                                 style="background: linear-gradient(45deg, #4e73df, #224abe);"
                                 {% if is_generating %}disabled{% endif %}
                                 onclick="showOneClickModal()">
                             <i class="bi bi-rocket-takeoff me-2"></i>一键全流程生成
                         </button>
                         <div class="text-center mt-1"><small class="text-muted" style="font-size: 0.7rem;">自动执行: 清空 -> 提示词 -> 基础图 -> 8镜图</small></div>
                    </div>

                    <div class="d-grid gap-3">
                        <!-- Step 1: Prompt -->
                        <div class="position-relative">
                            <button type="button" class="btn btn-outline-primary w-100 text-start d-flex align-items-center justify-content-between p-3 border-2 hover-shadow" 
                                    style="border-radius: 12px; border-color: #cfe2ff; background-color: #f8f9fa;" 
                                    {% if is_generating %}disabled{% endif %}
                                    onclick="handleTaskAction('GEN_PROMPT')">
                                <div>
                                    <div class="fw-bold text-primary mb-1"><span class="badge bg-primary me-2 rounded-pill">1</span>生成提示词 (LLM)</div>
                                    <div class="small text-secondary">
                                        自动生成正/反向提示词 
                                        <span id="current-llm-info" class="badge bg-light text-secondary border ms-1 fw-normal" style="font-size: 0.65rem;">
                                            <span class="spinner-border spinner-border-sm" style="width: 0.5rem; height: 0.5rem;"></span>
                                        </span>
                                    </div>
                                </div>
                                <i class="bi bi-chat-dots fs-4 text-primary opacity-50"></i>
                            </button>
                        </div>

                        <!-- Step 2: Base Image -->
                        <div class="p-3 rounded-3 border-2 border-success-subtle position-relative" style="background-color: #f1f8f5; border: 1px solid #d1e7dd;">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <div class="fw-bold text-success"><span class="badge bg-success me-2 rounded-pill">2</span>生成基础图</div>
                            </div>
                            
                            <div class="row g-2 mb-2">
                                <div class="col-6">
                                    <label class="text-label x-small text-success">宽</label>
                                    <input type="number" id="base_width" value="{{ sys_config.get('player_gen_width', 1024) }}" class="form-control form-control-sm border-success-subtle" {% if is_generating %}disabled{% endif %}>
                                </div>
                                <div class="col-6">
                                    <label class="text-label x-small text-success">高</label>
                                    <input type="number" id="base_height" value="{{ sys_config.get('player_gen_height', 768) }}" class="form-control form-control-sm border-success-subtle" {% if is_generating %}disabled{% endif %}>
                                </div>
                            </div>
                            <div class="mb-2">
                                <label class="text-label x-small text-success">Seed (0=随机)</label>
                                <input type="number" id="base_seed" value="{{ sys_config.get('player_gen_seed', 264590) }}" class="form-control form-control-sm border-success-subtle" {% if is_generating %}disabled{% endif %}>
                            </div>
                            <button type="button" class="btn btn-success w-100 btn-sm rounded-pill fw-medium" 
                                    {% if is_generating %}disabled{% endif %}
                                    onclick="handleTaskAction('GEN_BASE')">
                                <i class="bi bi-play-fill me-1"></i>开始生成
                            </button>
                        </div>

                        <!-- Step 3: 8 Views -->
                        <div class="position-relative">
                            <button type="button" class="btn btn-outline-warning w-100 text-start d-flex align-items-center justify-content-between p-3 border-2 hover-shadow"
                                    style="border-radius: 12px; border-color: #ffe69c; background-color: #fffbf0; color: #997404;"
                                    {% if not player.base_image_path or is_generating %}disabled title="请先生成基础图或等待任务完成"{% endif %}
                                    onclick="handleTaskAction('GEN_8VIEWS')">
                                <div>
                                    <div class="fw-bold mb-1" style="color: #997404;"><span class="badge bg-warning text-dark me-2 rounded-pill">3</span>生成 8 镜图</div>
                                    <div class="small text-secondary" style="color: #997404 !important;">基于基础图生成多视角</div>
                                </div>
                                <i class="bi bi-grid-3x3-gap fs-4 text-warning opacity-50"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Task History -->
            <div class="card">
                <div class="card-header bg-white border-bottom-0 pt-3 pb-0 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0"><i class="bi bi-clock-history me-2 text-primary"></i>最近任务</h6>
                    <div class="d-flex gap-1">
                        <!-- Force Reset Button -->
                        <button type="button" class="btn btn-icon btn-sm text-danger" style="width: 28px; height: 28px;" title="强制中断并清空所有任务（慎用）" onclick="showForceResetModal()">
                            <i class="bi bi-radioactive"></i>
                        </button>
                        <!-- Normal Clear Button -->
                        <form action="/tasks/clear_logs" method="post" style="display:inline;">
                            <input type="hidden" name="player_id" value="{{ player.id }}">
                            <button type="submit" class="btn btn-icon btn-sm text-secondary" style="width: 28px; height: 28px;" title="清除已完成/失败的任务记录">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                    </div>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        {% for task in tasks[:5] %}
                        <li id="task-{{ task.id }}" class="list-group-item border-0 border-bottom px-3 py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-medium text-dark" style="font-size: 0.9rem;">
                                        {% if task.task_type == 'GEN_PROMPT' %}生成提示词
                                        {% elif task.task_type == 'GEN_BASE' %}生成基础图
                                        {% elif task.task_type == 'GEN_8VIEWS' %}生成8镜图
                                        {% else %}{{ task.task_type }}{% endif %}
                                    </div>
                                    {% if task.error %}
                                    <div class="text-danger small mt-1" style="font-size: 0.75rem;">{{ task.error|truncate(30) }}</div>
                                    {% else %}
                                    <div class="text-muted small mt-1" style="font-size: 0.75rem;">
                                        {{ task._started_at_display or task.created_at.strftime('%H:%M:%S') }}
                                        {% if task.duration %}
                                        <span class="ms-1 text-success">用时: {{ task._duration_display or task.duration ~ 's' }}</span>
                                        {% elif task.run_time %}
                                        <span class="ms-1 text-primary run-time" data-start="{{ task.started_at }}">运行: {{ task.run_time }}</span>
                                        {% endif %}
                                        
                                        {% if task.status == 'running' and task.eta %}
                                        <span class="ms-1 text-info">ETA: {{ task.eta }}s</span>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    
                                    {% if task.status == 'running' %}
                                    <div class="progress mt-2" style="height: 4px; width: 100px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" {{ {'style': 'width: ' ~ (task.progress|default(0)) ~ '%'}|xmlattr }}></div>
                                    </div>
                                    {% endif %}
                                </div>
                                <div>
                                    {% if task.status == 'done' %}
                                    <span class="badge bg-success-subtle text-success rounded-pill">完成</span>
                                    {% elif task.status == 'failed' %}
                                    <span class="badge bg-danger-subtle text-danger rounded-pill">失败</span>
                                    {% elif task.status == 'running' %}
                                    <span class="badge bg-primary-subtle text-primary rounded-pill">
                                        <span class="spinner-border spinner-border-sm me-1" style="width: 0.7rem; height: 0.7rem;"></span>运行中
                                    </span>
                                    {% elif task.status == 'queued' %}
                                    <span class="badge bg-warning-subtle text-warning-emphasis rounded-pill">排队中</span>
                                    {% else %}
                                    <span class="badge bg-secondary-subtle text-secondary rounded-pill">{{ task.status }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <!-- Right Column: Results -->
        <div class="col-lg-8">
            <!-- Base Image -->
            <div class="card mb-4">
                <div class="card-header bg-white border-bottom-0 pt-3 pb-0">
                    <h6 class="fw-bold mb-0"><i class="bi bi-image me-2 text-primary"></i>基础图 (Base Image)</h6>
                </div>
                <div class="card-body">
                    <div class="bg-light rounded-4 overflow-hidden d-flex align-items-center justify-content-center" style="min-height: 400px; border: 2px dashed #e2e8f0;">
                        {% if player.base_image_path %}
                        <img src="/{{ player.base_image_path }}?v={{ request.query_params.get('t', 0) }}" class="img-fluid" style="max-height: 600px;">
                        {% else %}
                        <div class="text-center text-muted">
                            <i class="bi bi-image display-4 mb-2 d-block opacity-25"></i>
                            <span class="small">暂无基础图</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- 8 Views -->
            <div class="card">
                <div class="card-header bg-white border-bottom-0 pt-3 pb-0">
                    <h6 class="fw-bold mb-0"><i class="bi bi-grid-3x3-gap me-2 text-primary"></i>8 镜图集 (8 Views)</h6>
                </div>
                <div class="card-body">
                    <div class="row row-cols-2 row-cols-md-4 g-3" id="views-container">
                        {% set view_keys = ['close', 'wide', 'right45', 'right90', 'aerial', 'low', 'left45', 'left90'] %}
                        {% for key in view_keys %}
                        <div class="col view-card" data-key="{{ key }}">
                            <div class="card h-100 border-0 shadow-none bg-transparent">
                                <div class="card-img-top bg-light rounded-3 overflow-hidden d-flex align-items-center justify-content-center position-relative" style="aspect-ratio: 1/1; border: 1px solid #e2e8f0;">
                                    {% if views and key in views %}
                                    <img src="/{{ views[key] }}?v={{ request.query_params.get('t', 0) }}" class="img-fluid w-100 h-100" style="object-fit: cover; transition: transform 0.3s;">
                                    {% else %}
                                    <div class="placeholder-content text-center text-muted opacity-25">
                                        <span class="small">{{ key }}</span>
                                    </div>
                                    <img src="" class="img-fluid w-100 h-100 d-none" style="object-fit: cover; transition: transform 0.3s;">
                                    {% endif %}
                                </div>
                                <div class="text-center mt-2 small fw-bold text-secondary">
                                    {{ key }}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Force Reset Modal -->
<div class="modal fade" id="forceResetModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header border-bottom-0 pb-0">
        <h5 class="modal-title fw-bold text-danger"><i class="bi bi-radioactive me-2"></i>强制重置警告</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body pt-3">
        <div class="alert alert-danger bg-danger-subtle border-danger-subtle text-danger">
            <i class="bi bi-exclamation-octagon-fill me-2"></i><strong>高风险操作</strong>
        </div>
        <p class="mb-2">您正在尝试强制重置任务列表。此操作将：</p>
        <ul class="text-secondary small mb-3">
            <li>清空当前页面的任务列表</li>
            <li>无论任务处于排队、运行还是完成状态，都会被清除</li>
        </ul>
        <p class="mb-0 fw-bold text-dark">仅在任务卡死且无法通过常规手段停止时使用。</p>
      </div>
      <div class="modal-footer border-top-0 pt-0">
        <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-danger rounded-pill px-4" onclick="confirmForceReset()">
            <span id="force-reset-btn-text">确认重置</span>
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="clearConfigModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header border-bottom-0 pb-0">
        <h5 class="modal-title fw-bold text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>确认清空</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body pt-3">
        <p class="mb-3">确定要【一键清空】该角色的所有数据吗？</p>
        <div class="alert alert-danger bg-danger-subtle border-0 small">
            <ul class="mb-0 ps-3">
                <li>清空所有提示词和特征描述</li>
                <li>清空并<strong>物理删除</strong>基础图和8镜图文件</li>
                <li>此操作<strong>不可恢复</strong>！</li>
            </ul>
        </div>
      </div>
      <div class="modal-footer border-top-0 pt-0">
        <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-danger rounded-pill px-4" onclick="confirmClearConfig()">确认清空</button>
      </div>
    </div>
  </div>
</div>

<!-- One Click Modal -->
<div class="modal fade" id="oneClickModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header border-bottom-0 pb-0">
        <h5 class="modal-title fw-bold text-primary"><i class="bi bi-rocket-takeoff-fill me-2"></i>一键全流程生成</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="one-click-close-btn"></button>
      </div>
      <div class="modal-body pt-3">
        <div id="one-click-confirm-ui">
            <p class="mb-3">即将开始自动执行全流程任务：</p>
            <div class="d-flex flex-column gap-2 mb-3">
                 <div class="d-flex align-items-center text-secondary"><i class="bi bi-trash me-2"></i>1. 清空当前所有配置和图片</div>
                 <div class="d-flex align-items-center text-primary"><i class="bi bi-chat-dots me-2"></i>2. 生成提示词 (LLM)</div>
                 <div class="d-flex align-items-center text-success"><i class="bi bi-image me-2"></i>3. 生成基础图</div>
                 <div class="d-flex align-items-center text-warning"><i class="bi bi-grid-3x3-gap me-2"></i>4. 生成 8 镜图</div>
            </div>
            <div class="alert alert-warning bg-warning-subtle border-0 small">
                <i class="bi bi-info-circle me-1"></i> 任务将按顺序执行，如果某一步失败（如提示词生成失败），流程将自动中断。
            </div>
        </div>
        
        <div id="one-click-running-ui" style="display:none;">
            <div class="text-center py-4">
                <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
                <h6 class="fw-bold" id="one-click-step-text">正在初始化...</h6>
                <p class="text-muted small">全流程自动执行中</p>
                <button class="btn btn-outline-danger btn-sm rounded-pill mt-3" onclick="interruptOneClickFlow()">
                    <i class="bi bi-stop-circle me-1"></i>停止执行
                </button>
            </div>
        </div>

        <div id="one-click-error-ui" style="display:none;">
            <div class="alert alert-danger border-0">
                <div class="d-flex">
                    <i class="bi bi-x-circle-fill me-2 fs-4"></i>
                    <div>
                        <h6 class="fw-bold mb-1">执行中断</h6>
                        <div id="one-click-error-msg" class="small"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="one-click-success-ui" style="display:none;">
            <div class="text-center py-4 text-success">
                <i class="bi bi-check-circle-fill display-4 mb-3"></i>
                <h6 class="fw-bold">全流程生成完成！</h6>
                <p class="text-muted small">您可以现在查看生成的结果了。</p>
            </div>
        </div>
      </div>
      <div class="modal-footer border-top-0 pt-0">
        <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal" id="one-click-cancel-btn">取消</button>
        <button type="button" class="btn btn-primary rounded-pill px-4" onclick="startOneClickFlow()" id="one-click-start-btn">开始执行</button>
        <button type="button" class="btn btn-primary rounded-pill px-4" data-bs-dismiss="modal" id="one-click-finish-btn" style="display:none;">太棒了</button>
      </div>
    </div>
  </div>
</div>

<!-- Hidden element to pass running task IDs safely to JS -->
<div id="running-tasks-data" 
     data-task-ids="{% for task in tasks if task.status in ['running', 'queued'] %}{{ task.id }}{% if not loop.last %},{% endif %}{% endfor %}"
     style="display:none;"></div>

<script>
// Modals
let clearModal, oneClickModal, forceResetModal;

document.addEventListener('DOMContentLoaded', () => {
    checkTaskStatus();
    fetchCurrentLLM();
    clearModal = new bootstrap.Modal(document.getElementById('clearConfigModal'));
    oneClickModal = new bootstrap.Modal(document.getElementById('oneClickModal'));
    forceResetModal = new bootstrap.Modal(document.getElementById('forceResetModal'));
});

async function fetchCurrentLLM() {
    try {
        const response = await fetch('/api/llm/current');
        const data = await response.json();
        const badge = document.getElementById('current-llm-info');
        if (badge) {
            badge.innerText = `${data.provider}/${data.model || 'Default'}`;
            // Optional: Add tooltip with full name
            badge.title = data.name;
        }
    } catch (e) {
        console.error("Failed to fetch LLM info", e);
    }
}

function showClearModal() {
    clearModal.show();
}

function showForceResetModal() {
    forceResetModal.show();
}

function showOneClickModal() {
    oneClickModal.show();
}

async function confirmForceReset() {
    const btnText = document.getElementById('force-reset-btn-text');
    const originalText = btnText.innerText;
    btnText.innerText = "处理中...";
    
    // Disable button to prevent double click
    const btn = document.querySelector('#forceResetModal .btn-danger');
    btn.disabled = true;

    try {
        const formData = new FormData();
        formData.append('player_id', "{{ player.id }}");
        
        const response = await fetch('/tasks/force_reset', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
            forceResetModal.hide();
            // Show success toast or reload
            showToast("重置成功！页面即将刷新。", "success");
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showToast(`重置失败: ${data.detail || '未知错误'}`, "error");
        }
    } catch (e) {
        console.error(e);
        showToast("网络请求失败，请检查控制台日志。", "error");
    } finally {
        btnText.innerText = originalText;
        btn.disabled = false;
    }
}

function confirmClearConfig() {
    // Submit the form programmatically
    // We use the existing form submission to handle redirect, or we can fetch.
    // The existing form does a POST and redirects. Let's use that for simplicity.
    document.getElementById('clear-config-form').submit();
}

// One Click Flow State
let isOneClickRunning = false;
let currentRunningTaskId = null; // Track current task for interruption

async function startOneClickFlow() {
    if (isOneClickRunning) return;
    isOneClickRunning = true;
    currentRunningTaskId = null;
    
    // UI State
    const confirmUI = document.getElementById('one-click-confirm-ui');
    const runningUI = document.getElementById('one-click-running-ui');
    const errorUI = document.getElementById('one-click-error-ui');
    const successUI = document.getElementById('one-click-success-ui');
    const stepText = document.getElementById('one-click-step-text');
    const errorMsg = document.getElementById('one-click-error-msg');
    
    const startBtn = document.getElementById('one-click-start-btn');
    const cancelBtn = document.getElementById('one-click-cancel-btn');
    const closeBtn = document.getElementById('one-click-close-btn');
    const finishBtn = document.getElementById('one-click-finish-btn');

    confirmUI.style.display = 'none';
    runningUI.style.display = 'block';
    errorUI.style.display = 'none';
    successUI.style.display = 'none';
    startBtn.style.display = 'none';
    cancelBtn.style.display = 'none';
    closeBtn.style.display = 'none';
    
    // ALLOW SCROLLING: Don't set cursor wait globally, maybe just on modal? 
    // And allow body scroll if possible. 
    // Actually, bootstrap modal blocks body scroll by default.
    // We can manually re-enable it? Or just let user scroll inside modal?
    // User wants to scroll the *page* to see images.
    // If modal is open, page scroll is usually blocked.
    // We can make the modal non-blocking (remove backdrop static? no, user wants to see progress).
    // Let's remove 'modal-open' class from body?
    document.body.classList.remove('modal-open');
    document.body.style.overflow = 'auto'; // Force scrollable
    
    try {
        // Step 1: Clear Config
        stepText.innerText = "正在清空旧配置与图片...";
        console.log("[OneClick] Clearing config...");
        const clearResp = await fetch(`/players/{{ player.id }}/clear_config`, { method: 'POST' });
        if (!clearResp.ok && !clearResp.redirected) throw new Error("清空配置失败");
        await updatePageContent();
        
        // Step 2: Gen Prompt
        stepText.innerText = "步骤 1/3: 正在生成提示词 (LLM)...";
        console.log("[OneClick] Generating Prompt...");
        currentRunningTaskId = await submitTask('GEN_PROMPT');
        if (!currentRunningTaskId) throw new Error("提交提示词任务失败");
        
        const promptSuccess = await waitForTask(currentRunningTaskId);
        if (!promptSuccess) throw new Error("提示词生成失败或被中断");
        await updatePageContent();
        
        // Step 3: Gen Base
        stepText.innerText = "步骤 2/3: 正在生成基础全身图...";
        console.log("[OneClick] Generating Base...");
        currentRunningTaskId = await submitTask('GEN_BASE');
        if (!currentRunningTaskId) throw new Error("提交基础图任务失败");
        
        const baseSuccess = await waitForTask(currentRunningTaskId);
        if (!baseSuccess) throw new Error("基础图生成失败或被中断");
        await updatePageContent();
        
        // Step 4: Gen 8 Views
        stepText.innerText = "步骤 3/3: 正在生成 8 镜多视角图...";
        console.log("[OneClick] Generating 8 Views...");
        currentRunningTaskId = await submitTask('GEN_8VIEWS');
        if (!currentRunningTaskId) throw new Error("提交8镜图任务失败");
        
        const viewsSuccess = await waitForTask(currentRunningTaskId);
        if (!viewsSuccess) throw new Error("8镜图生成失败或被中断");
        
        // Success
        runningUI.style.display = 'none';
        successUI.style.display = 'block';
        finishBtn.style.display = 'inline-block';
        closeBtn.style.display = 'inline-block';
        
    } catch (e) {
        if (e.message.includes("中断")) {
             console.log("Flow interrupted by user.");
             errorMsg.innerText = "用户已手动停止任务。";
        } else {
             console.error(e);
             errorMsg.innerText = e.message;
        }
        runningUI.style.display = 'none';
        errorUI.style.display = 'block';
        finishBtn.innerText = "关闭";
        finishBtn.style.display = 'inline-block';
        finishBtn.className = "btn btn-secondary rounded-pill px-4";
        closeBtn.style.display = 'inline-block';
    } finally {
        isOneClickRunning = false;
        currentRunningTaskId = null;
        document.body.style.cursor = 'default';
        await updatePageContent();
    }
}

async function interruptOneClickFlow() {
    if (!isOneClickRunning) return;
    
    if (confirm("确定要停止当前任务吗？")) {
        // 1. Call backend interrupt
        try {
            // We need a general interrupt endpoint or interrupt specific task?
            // If we have currentRunningTaskId, interrupt that.
            if (currentRunningTaskId) {
                await fetch(`/tasks/interrupt`, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `task_id=${currentRunningTaskId}`
                });
            } else {
                // Just global interrupt?
                await fetch(`/tasks/interrupt`, { method: 'POST' });
            }
        } catch(e) {
            console.error("Interrupt failed", e);
        }
        
        // 2. The waitForTask loop will detect 'failed' or we throw error here to stop flow immediately
        // Actually waitForTask waits for status change. Backend interrupt should set status to failed/cancelled.
        // But we can also force throw here to update UI immediately?
        // No, let the loop handle it naturally.
    }
}

// Unified Task Action Handler (No Forms)
async function handleTaskAction(taskType) {
    const playerId = "{{ player.id }}";
    const openaiConfigured = "{{ openai_configured }}";
    const playerMark = "{{ (player.player_mark or '')|replace('\n', ' ')|replace('\r', '')|escape }}"; // Simple escape for JS string

    // Validation
    if (taskType === 'GEN_PROMPT') {
        if (openaiConfigured !== 'True') {
            showToast("未检测到有效的 OpenAI API Key！请在项目根目录 .env 文件中配置 OPENAI_API_KEY。", "error");
            return;
        }
        // Check playerMark only if we are not in OneClick flow (which handles clears)
        // Actually, OneClick flow clears config, so playerMark might be empty?
        // Wait, if OneClick clears config, then playerMark is gone?
        // No, player_desc (features) should be kept?
        // User said: "人物特征描述 (合成用) 、正向提示词 (基图)、反向提示词都被清空"
        // If "人物特征描述" (player_desc) is cleared, then GEN_PROMPT will fail because it needs input?
        // User said: "生成提示词后自动填充" for player_desc.
        // But GEN_PROMPT needs `player_mark` (备注) or `player_desc`?
        // Let's check `generate_player_prompts`. It uses `name, sex, mark`.
        // `player_mark` is the immutable "备注" on the player card (top left).
        // `player_desc` is the "特征描述" in the form.
        // So `player_mark` is SAFE from clear_config. `clear_config` clears `player_desc`.
        // So validation against `player_mark` is correct.
        
        if (!playerMark || playerMark.trim() === '' || playerMark === 'None') {
            showToast("请先填写人物形象备注（player_mark）再生成提示词！", "warning");
            return;
        }
    }

    // Prepare Data
    const formData = new FormData();
    formData.append('player_id', playerId);
    formData.append('task_type', taskType);

    if (taskType === 'GEN_BASE') {
        formData.append('width', document.getElementById('base_width').value);
        formData.append('height', document.getElementById('base_height').value);
        formData.append('seed', document.getElementById('base_seed').value);
    }

    // UI Feedback: Disable all action buttons
    const buttons = document.querySelectorAll('.card-body button');
    buttons.forEach(btn => {
        btn.disabled = true;
        if (btn.onclick && btn.onclick.toString().includes(taskType)) {
             btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>提交中...';
        }
    });

    try {
        const response = await fetch('/tasks/create', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            console.log("Task submitted successfully. Fetching updated UI...");
            // Immediately fetch partial update
            await updatePageContent();
        } else {
            showToast('任务提交失败，服务器返回错误。', 'error');
            setTimeout(() => window.location.reload(), 1500); // Fallback to reload on error to reset state
        }
    } catch (error) {
        console.error('Network Error:', error);
        showToast('网络连接错误。', 'error');
        setTimeout(() => window.location.reload(), 1500);
    }
}

// Helper: Submit Task
async function submitTask(taskType) {
    // Reuse logic from handleTaskAction but return ID
    const formData = new FormData();
    formData.append('player_id', "{{ player.id }}");
    formData.append('task_type', taskType);
    
    if (taskType === 'GEN_BASE') {
        // Get values from DOM, which should be reset or default
        formData.append('width', document.getElementById('base_width').value);
        formData.append('height', document.getElementById('base_height').value);
        formData.append('seed', document.getElementById('base_seed').value);
    }
    
    const response = await fetch('/tasks/create', { method: 'POST', body: formData });
    if (response.ok) {
        // Backend returns RedirectResponse, so response.json() will fail with HTML content
        // We just need to know it was successful.
        // Wait a bit for DB to update
        await new Promise(r => setTimeout(r, 1000));
        return await findLatestTask(taskType);
    }
    return null;
}

// Helper: Find latest task ID of type
async function findLatestTask(taskType) {
    // We can use a special API or just fetch status of all recent tasks?
    // Let's hack: fetch page content, parse running-tasks-data? 
    // No, running-tasks-data might contain multiple.
    // Let's fetch /api/tasks/status?task_ids=... 
    // We don't know IDs.
    
    // We need an API to get latest task.
    // Let's just blindly wait for the task that is running.
    // We can assume the "latest" task in the list is the one we just created.
    // Let's use the UI update to find it.
    await updatePageContent();
    const listItems = document.querySelectorAll('.list-group-item');
    if (listItems.length > 0) {
        const firstItem = listItems[0];
        const id = firstItem.id.replace('task-', '');
        // Check type?
        const typeText = firstItem.querySelector('.fw-medium').innerText;
        // Map UI text to type
        let typeMatch = false;
        if (taskType === 'GEN_PROMPT' && typeText.includes('生成提示词')) typeMatch = true;
        if (taskType === 'GEN_BASE' && typeText.includes('生成基础图')) typeMatch = true;
        if (taskType === 'GEN_8VIEWS' && typeText.includes('生成8镜图')) typeMatch = true;
        
        if (typeMatch) return id;
    }
    return null;
}

// Helper: Wait for task completion
async function waitForTask(taskId) {
    return new Promise((resolve) => {
        const check = setInterval(async () => {
             // Use our cache or fetch
             const url = `/api/tasks/status?task_ids=${taskId}&_t=${new Date().getTime()}`;
             try {
                 const res = await fetch(url);
                 const data = await res.json();
                 const task = data[taskId];
                 if (task) {
                     if (task.status === 'done') {
                         clearInterval(check);
                         resolve(true);
                     } else if (task.status === 'failed') {
                         clearInterval(check);
                         resolve(false);
                     }
                 }
             } catch(e) {
                 // ignore network blip
             }
        }, 2000);
    });
}
async function updatePageContent() {
    try {
        // Add timestamp to avoid cache
        const response = await fetch(window.location.href + '?t=' + new Date().getTime());
        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        // 1. Update Task List
        const newTaskHistory = doc.querySelector('.card .list-group');
        const currentTaskHistory = document.querySelector('.card .list-group');
        if (newTaskHistory && currentTaskHistory) {
            currentTaskHistory.innerHTML = newTaskHistory.innerHTML;
        }

        // 2. Update Prompts Form
        const newPromptForm = doc.querySelector('form[action*="update_prompts"]');
        const currentPromptForm = document.querySelector('form[action*="update_prompts"]');
        if (newPromptForm && currentPromptForm) {
            // Preserve input focus if needed, but here we just replace content
            currentPromptForm.innerHTML = newPromptForm.innerHTML;
        }

        // 3. Update Images Area (Base & Views)
        const newImagesArea = doc.querySelector('.col-lg-8');
        const currentImagesArea = document.querySelector('.col-lg-8');
        if (newImagesArea && currentImagesArea) {
            currentImagesArea.innerHTML = newImagesArea.innerHTML;
        }
        
        // 4. Update Status Badge
        const newStatus = doc.querySelector('.d-flex.align-items-center.gap-2');
        const currentStatus = document.querySelector('.d-flex.align-items-center.gap-2');
        if (newStatus && currentStatus) {
            currentStatus.innerHTML = newStatus.innerHTML;
        }

        // 5. Update Hidden Task Data
        const newRunningData = doc.getElementById('running-tasks-data');
        const currentRunningData = document.getElementById('running-tasks-data');
        if (newRunningData && currentRunningData) {
            currentRunningData.setAttribute('data-task-ids', newRunningData.getAttribute('data-task-ids'));
            // Trigger polling check immediately
            checkTaskStatus(); 
        }
        
        // 6. Reset Buttons if no running tasks found in new HTML
        const hasRunningTasks = newRunningData.getAttribute('data-task-ids').trim().length > 0;
        if (!hasRunningTasks) {
             // Re-enable inputs/buttons
             document.querySelectorAll('input, button').forEach(el => el.disabled = false);
             
             // Let's replace the Action Card content to be safe and clean
             const newActionsCardBody = doc.querySelectorAll('.col-lg-4 .card')[2].querySelector('.card-body');
             const currentActionsCardBody = document.querySelectorAll('.col-lg-4 .card')[2].querySelector('.card-body');
             if (newActionsCardBody && currentActionsCardBody) {
                 currentActionsCardBody.innerHTML = newActionsCardBody.innerHTML;
             }
        }

    } catch (err) {
        console.error("Failed to update page content:", err);
    }
}

// Extract polling logic to be callable
const taskStatusCache = {};

function checkTaskStatus() {
    const dataElement = document.getElementById('running-tasks-data');
    if (!dataElement) return;
    
    let runningTaskIds = [];
    try {
        const rawData = dataElement.getAttribute('data-task-ids');
        if (rawData && rawData.trim() !== '') {
            runningTaskIds = rawData.split(',').filter(id => id.trim() !== "");
        }
    } catch (e) {
        runningTaskIds = [];
    }

    if (runningTaskIds.length > 0) {
        // Show indicator
        const statusBadge = document.querySelector('.d-flex.align-items-center.gap-2');
        if (statusBadge && !statusBadge.querySelector('.spinner-grow')) {
            const indicator = document.createElement('span');
            indicator.className = 'badge bg-light text-primary border ms-2';
            indicator.innerHTML = '<span class="spinner-grow spinner-grow-sm me-1" style="width: 0.5rem; height: 0.5rem;"></span>同步中...';
            statusBadge.appendChild(indicator);
        }
        
        // Poll immediately
        const url = `/api/tasks/status?task_ids=${runningTaskIds.join(',')}&_t=${new Date().getTime()}`;
        console.log("Polling:", url);
        
        fetch(url)
            .then(res => res.json())
            .then(data => {
                let shouldRefresh = false;
                for (const taskId of runningTaskIds) {
                    const taskData = data[taskId] || data[String(taskId)];
                    if (!taskData) continue;
                    
                    const status = taskData.status;
                    const progress = taskData.progress;
                    const eta = taskData.eta || 0;
                    const runTime = taskData.run_time || "";
                    const viewsStatus = taskData.views_status || [];
                    
                    const prevStatus = taskStatusCache[taskId];
                    const prevViewsLen = taskStatusCache[taskId + '_views'] || 0;
                    
                    // 1. Status Change Check
                    if (status && (!prevStatus || status !== prevStatus)) {
                        console.log(`Task ${taskId} status update: ${prevStatus || 'new'} -> ${status}`);
                        shouldRefresh = true;
                    }
                    
                    // 2. Incremental Views Check (refresh if new views appear)
                    // Note: We don't need full refresh for image if we handle it via JS, 
                    // but updatePageContent is safer for now. 
                    // Let's try to update just the images if possible, or just trigger refresh.
                    if (viewsStatus.length > prevViewsLen) {
                         console.log(`Task ${taskId} views update: ${prevViewsLen} -> ${viewsStatus.length}`);
                         shouldRefresh = true;
                    }
                    
                    // Update Progress Bar & Info directly
                    const taskItem = document.getElementById(`task-${taskId}`);
                    if (taskItem) {
                        // 1. Update Progress Bar (Visible for all running/done/failed tasks)
                        const progressBar = taskItem.querySelector('.progress-bar');
                        if (progressBar) {
                            progressBar.style.width = `${progress}%`;
                        }
                        
                        // 2. Update Status Text & Badge
                        const badge = taskItem.querySelector('.badge');
                        if (badge) {
                            if (status === 'running') {
                                badge.className = 'badge rounded-pill bg-primary-subtle text-primary border border-primary-subtle';
                                badge.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>运行中';
                            } else if (status === 'done') {
                                badge.className = 'badge rounded-pill bg-success-subtle text-success border border-success-subtle';
                                badge.innerText = '完成';
                            } else if (status === 'failed') {
                                badge.className = 'badge rounded-pill bg-danger-subtle text-danger border border-danger-subtle';
                                badge.innerText = '失败';
                            }
                        }

                        // 3. Update Time Info (Critical: Ensure duration is shown for ALL finished tasks)
                        const timeDiv = taskItem.querySelector('.text-muted.small.mt-1');
                        if (timeDiv) {
                            let html = `${taskData.started_at || ''}`;
                            
                            if (status === 'done' || status === 'failed') {
                                // Show final duration
                                if (taskData.duration) {
                                    html += `<span class="ms-2 text-success fw-bold">用时: ${taskData.duration}</span>`;
                                } else if (taskData.completed_at) {
                                    // Fallback if duration is missing in API but we have completed_at
                                    html += `<span class="ms-2 text-success fw-bold">已完成</span>`;
                                }
                            } else if (status === 'running') {
                                // Show live runtime and ETA
                                if (runTime) html += `<span class="ms-2 text-primary">运行: ${runTime}</span>`;
                                if (eta > 0) html += `<span class="ms-2 text-info">ETA: ${eta}s</span>`;
                            }
                            
                            timeDiv.innerHTML = html;
                        }
                    }
                    
                    // Update cache
                    taskStatusCache[taskId] = status;
                    taskStatusCache[taskId + '_views'] = viewsStatus.length;
                }
                
                if (shouldRefresh) {
                    // Check if any task is done/failed
                    const anyDone = Object.values(data).some(t => t.status === 'done' || t.status === 'failed');
                    
                    if (anyDone) {
                         // Show toast only for completion
                        const toast = document.createElement('div');
                        toast.className = 'position-fixed top-0 start-50 translate-middle-x mt-3 badge bg-success shadow-lg p-3';
                        toast.style.zIndex = '9999';
                        toast.innerHTML = '<i class="bi bi-check-circle me-2"></i>任务状态已更新...';
                        document.body.appendChild(toast);
                        setTimeout(() => toast.remove(), 3000);
                    }
                    
                    // Update UI without reload
                    updatePageContent();
                }
            })
            .catch(e => console.error(e));
    }
}

// Init polling loop
setInterval(checkTaskStatus, 2000);

// Initial check on load
document.addEventListener('DOMContentLoaded', checkTaskStatus);

function confirmClearConfig() {
    if (confirm("确定要【一键清空】所有配置吗？\n\n这将执行以下操作：\n1. 清空提示词、特征描述\n2. 清空基础图、8镜图记录\n3. 【物理删除】所有已生成的图片文件\n\n此操作不可恢复！")) {
        document.getElementById('clear-config-form').submit();
    }
}
</script>
{% endblock %}
