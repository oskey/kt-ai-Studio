{% extends "base.html" %}

{% block content %}
<div class="container">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold mb-1">项目列表</h4>
            <p class="text-secondary small mb-0">管理您的所有创作项目</p>
        </div>
        <button type="button" class="btn btn-primary shadow-sm rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#createProjectModal">
            <i class="bi bi-plus-lg me-1"></i>新建项目
        </button>
    </div>

    <!-- Project List (App Style) -->
    <div class="d-flex flex-column">
        {% for project in projects %}
        <div class="app-list-item">
            <!-- Icon -->
            <div class="app-avatar project me-3">
                <i class="bi bi-folder-fill"></i>
            </div>
            
            <!-- Content -->
            <div class="flex-grow-1 min-width-0">
                <div class="d-flex align-items-center mb-1">
                    <h6 class="mb-0 fw-bold text-dark me-2 text-truncate">{{ project.name }}</h6>
                    <span class="badge bg-light text-secondary border rounded-pill fw-normal">{{ project.project_code }}</span>
                    {% if project.style %}
                    <span class="badge bg-primary-subtle text-primary border border-primary-subtle rounded-pill fw-normal ms-2 small">
                        <i class="bi bi-palette-fill me-1"></i>{{ project.style.name }}
                    </span>
                    {% endif %}
                </div>
                <p class="text-secondary small mb-0 text-truncate" title="{{ project.mark or '' }}">
                    {{ project.mark or '暂无备注' }}
                </p>
            </div>

            <!-- Date (Desktop only) -->
            <div class="text-end text-muted small me-4 d-none d-md-block" style="min-width: 100px;">
                <i class="bi bi-clock me-1"></i>{{ project.created_at.strftime('%Y-%m-%d') }}
            </div>

            <!-- Actions -->
            <div class="d-flex gap-2">
                <button class="btn btn-light btn-sm rounded-pill px-3 fw-medium text-success bg-success-subtle" 
                        onclick="openAutoGenStoryModal('{{ project.id }}', '{{ project.name }}')">
                    <i class="bi bi-magic me-1"></i>自动剧情
                </button>
                <a href="/projects/{{ project.id }}" class="btn btn-light btn-sm rounded-pill px-3 fw-medium text-primary bg-indigo-subtle">
                    进入
                </a>
                <div class="dropdown">
                    <button class="btn btn-icon" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow border-0 rounded-3">
                        <li>
                            <button class="dropdown-item py-2" 
                                    data-id="{{ project.id }}"
                                    data-name="{{ project.name }}"
                                    data-mark="{{ project.mark or '' }}"
                                    data-style-id="{{ project.style_id or '' }}"
                                    onclick="editProject(this.getAttribute('data-id'), this.getAttribute('data-name'), this.getAttribute('data-mark'), this.getAttribute('data-style-id'))">
                                <i class="bi bi-pencil me-2 text-secondary"></i>编辑信息
                            </button>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <button class="dropdown-item py-2 text-danger" onclick="confirmDelete('{{ project.id }}', '{{ project.name }}')">
                                <i class="bi bi-trash me-2"></i>删除项目
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        {% else %}
        <div class="text-center py-5">
            <div class="bg-white rounded-circle d-inline-flex align-items-center justify-content-center shadow-sm mb-3" style="width: 80px; height: 80px;">
                <i class="bi bi-inbox text-secondary fs-2"></i>
            </div>
            <h5 class="text-dark">暂无项目</h5>
            <p class="text-secondary">点击右上角新建一个项目吧</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Create Project Modal -->
<div class="modal fade" id="createProjectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">新建项目</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="/projects" method="post">
                <div class="modal-body pt-4">
                    <div class="mb-3">
                        <label class="text-label mb-1">项目名称 <span class="text-danger">*</span></label>
                        <input type="text" name="name" class="form-control form-control-lg bg-light border-0" required placeholder="例如：赛博朋克短片">
                    </div>
                    <div class="mb-3">
                        <label class="text-label mb-1">项目代号 (ID) <span class="text-danger">*</span></label>
                        <input type="text" name="project_code" class="form-control bg-light border-0" required placeholder="例如：cyber_2077">
                        <div class="form-text small">用于生成文件路径，不支持中文。</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="text-label mb-1">画风锁定 (Style Preset) <span class="text-danger">*</span></label>
                        <select name="style_id" class="form-select form-select-lg bg-light border-0" required>
                            <option value="" disabled selected>请选择项目画风...</option>
                            {% for style in styles %}
                            <option value="{{ style.style_id }}">{{ style.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text small text-warning"><i class="bi bi-lock-fill me-1"></i>画风一旦选定，项目内所有生成将强制继承该风格，且不可修改。</div>
                    </div>

                    <div class="mb-0">
                        <label class="text-label mb-1">备注</label>
                        <textarea name="mark" class="form-control bg-light border-0" rows="3" placeholder="项目简介..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0 pb-4">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary rounded-pill px-4">创建项目</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Project Modal -->
<div class="modal fade" id="editProjectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">编辑项目</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editProjectForm" method="post">
                <div class="modal-body pt-4">
                    <div class="mb-3">
                        <label class="text-label mb-1">项目名称 <span class="text-danger">*</span></label>
                        <input type="text" name="name" id="editProjectName" class="form-control form-control-lg bg-light border-0" required>
                    </div>
                    <div class="mb-3">
                        <label class="text-label mb-1">画风锁定 (Style Preset)</label>
                        <select name="style_id" id="editProjectStyle" class="form-select form-select-lg bg-light border-0" required>
                            <option value="" disabled>请选择项目画风...</option>
                            {% for style in styles %}
                            <option value="{{ style.style_id }}">{{ style.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text small text-danger"><i class="bi bi-exclamation-triangle-fill me-1"></i>注意：更改画风将影响项目后续所有生成任务的一致性。</div>
                    </div>
                    <div class="mb-3">
                        <label class="text-label mb-1">备注</label>
                        <textarea name="mark" id="editProjectMark" class="form-control bg-light border-0" rows="3"></textarea>
                    </div>
                    <div class="p-3 rounded-3 bg-primary-subtle text-primary small">
                        <i class="bi bi-info-circle-fill me-2"></i>项目代号不可修改以保证文件路径一致性。
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0 pb-4">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary rounded-pill px-4">保存修改</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteProjectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-body text-center p-4">
                <div class="text-danger mb-3">
                    <i class="bi bi-exclamation-circle-fill display-4"></i>
                </div>
                <h5 class="fw-bold mb-2">确认删除?</h5>
                <p class="text-secondary small mb-4">
                    您确定要删除项目 <strong id="deleteProjectName" class="text-dark"></strong> 吗？此操作不可恢复。
                </p>
                <form id="deleteProjectForm" method="post" class="d-grid gap-2">
                    <button type="submit" class="btn btn-danger rounded-pill">确认删除</button>
                    <button type="button" class="btn btn-light rounded-pill" data-bs-dismiss="modal">取消</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function editProject(id, name, mark, styleId) {
    document.getElementById('editProjectName').value = name;
    document.getElementById('editProjectMark').value = mark;
    document.getElementById('editProjectStyle').value = styleId;
    document.getElementById('editProjectForm').action = '/projects/' + id + '/edit';
    var editModal = new bootstrap.Modal(document.getElementById('editProjectModal'));
    editModal.show();
}

function confirmDelete(id, name) {
    document.getElementById('deleteProjectName').textContent = name;
    document.getElementById('deleteProjectForm').action = '/projects/' + id + '/delete';
    var deleteModal = new bootstrap.Modal(document.getElementById('deleteProjectModal'));
    deleteModal.show();
}
</script>
<!-- Auto Generate Story Modal -->
<div class="modal fade" id="autoGenStoryModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">
                    <i class="bi bi-stars text-warning me-2"></i>自动创建剧情
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="autoGenCloseBtn"></button>
            </div>
            <div class="modal-body pt-4">
                <!-- Input State -->
                <div id="autoGenInputState">
                    <p class="text-secondary small mb-3">
                        根据剧情描述，AI 将自动分析并创建项目所需的<span class="text-dark fw-bold">角色</span>、<span class="text-dark fw-bold">场景</span>和<span class="text-dark fw-bold">对话</span>。
                        生成过程完全遵循项目锁定的画风。
                    </p>
                    
                    <form id="autoGenStoryForm">
                        <input type="hidden" id="autoGenProjectId">
                        
                        <div class="mb-4">
                            <label class="text-label mb-1">剧情梗概 <span class="text-danger">*</span></label>
                            <textarea id="autoGenContent" class="form-control bg-light border-0" rows="6" 
                                      placeholder="请输入剧情描述... 例如：主角小明在未来赛博都市醒来，发现自己被机械警察包围..." required></textarea>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-6">
                                <label class="text-label mb-1">插入位置 (第几幕/集)</label>
                                <input type="number" id="autoGenEpisodeStart" class="form-control bg-light border-0" value="1" min="1" max="999">
                                <div class="form-text text-secondary small">后续场景将从第 <span id="episodeStartDisplay" class="fw-bold">1</span> 幕开始递增</div>
                            </div>
                            <div class="col-6">
                                <label class="text-label mb-1">生成数量限制 (可选)</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-0 text-secondary small">角色</span>
                                    <input type="number" id="autoGenMaxChars" class="form-control bg-light border-0" value="5" min="1" max="20">
                                    <span class="input-group-text bg-light border-0 text-secondary small">场景</span>
                                    <input type="number" id="autoGenMaxScenes" class="form-control bg-light border-0" value="10" min="1" max="50">
                                </div>
                            </div>
                        </div>

                        <!-- Single Player Mode Option -->
                        <div class="mb-4">
                            <div class="form-check form-switch p-0 d-flex align-items-center bg-light rounded-3 p-3">
                                <label class="form-check-label flex-grow-1 cursor-pointer" for="autoGenSingleOnly">
                                    <span class="fw-bold text-dark d-block mb-1">仅生成单人场景 (讲故事模式)</span>
                                    <span class="text-secondary small d-block" style="line-height: 1.4;">
                                        勾选后，AI 将强制把多人对话拆解为连续的单人镜头。
                                        <br>场景只绑定1名角色，优选特写/近景，确保画面焦点集中。
                                    </span>
                                </label>
                                <div class="form-check ms-3">
                                    <input class="form-check-input" type="checkbox" id="autoGenSingleOnly" style="width: 3em; height: 1.5em;">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="text-label mb-2">生成模式</label>
                            <div class="d-flex gap-3">
                                <div class="form-check card flex-row align-items-center p-3 border-0 bg-light flex-fill">
                                    <input class="form-check-input mt-0 me-2" type="radio" name="genMode" id="modeAppend" value="append" checked>
                                    <label class="form-check-label w-100 cursor-pointer" for="modeAppend">
                                        <div class="fw-bold text-dark">增加模式 (默认)</div>
                                        <div class="small text-secondary">保留现有数据</div>
                                    </label>
                                </div>
                                <div class="form-check card flex-row align-items-center p-3 border-0 bg-light flex-fill">
                                    <input class="form-check-input mt-0 me-2" type="radio" name="genMode" id="modeOverwrite" value="overwrite">
                                    <label class="form-check-label w-100 cursor-pointer" for="modeOverwrite">
                                        <div class="fw-bold text-danger">覆盖模式</div>
                                        <div class="small text-secondary">清空已有数据</div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary rounded-pill py-2 fw-bold">
                                <i class="bi bi-magic me-2"></i>开始生成
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Progress State -->
                <div id="autoGenProgressState" class="d-none text-center py-4">
                    <div class="mb-4">
                        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <h5 class="fw-bold mb-2">正在生成剧情资产...</h5>
                    <p class="text-secondary small mb-4">请稍候，LLM 正在分析剧情并构建世界观。</p>
                    
                    <!-- Progress Bar -->
                    <div class="progress mb-3" style="height: 10px;">
                        <div id="autoGenProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    
                    <!-- Log Output -->
                    <div class="card bg-light border-0 text-start">
                        <div class="card-body p-3 font-monospace small text-secondary" style="max-height: 150px; overflow-y: auto;" id="autoGenLog">
                            > 等待任务启动...
                        </div>
                    </div>
                </div>
                
                <!-- Success State -->
                <div id="autoGenSuccessState" class="d-none text-center py-4">
                    <div class="mb-3 text-success">
                        <i class="bi bi-check-circle-fill display-1"></i>
                    </div>
                    <h4 class="fw-bold mb-2">生成完成!</h4>
                    <p class="text-secondary mb-4">
                        成功创建 <span id="successPlayerCount" class="fw-bold text-dark">0</span> 个角色，
                        <span id="successSceneCount" class="fw-bold text-dark">0</span> 个场景。
                    </p>
                    <div class="d-grid">
                        <button class="btn btn-primary rounded-pill py-2 fw-bold" onclick="finishAutoGen()">
                            进入项目
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let pollingInterval = null;

document.getElementById('autoGenEpisodeStart').addEventListener('input', function(e) {
    document.getElementById('episodeStartDisplay').textContent = e.target.value || 1;
});

function openAutoGenStoryModal(projectId, projectName) {
    document.getElementById('autoGenProjectId').value = projectId;
    document.getElementById('autoGenContent').value = '';
    document.getElementById('modeAppend').checked = true;
    document.getElementById('autoGenEpisodeStart').value = 1;
    document.getElementById('episodeStartDisplay').textContent = 1;
    document.getElementById('autoGenMaxChars').value = 5;
    document.getElementById('autoGenMaxScenes').value = 10;
    
    // Reset States
    document.getElementById('autoGenInputState').classList.remove('d-none');
    document.getElementById('autoGenProgressState').classList.add('d-none');
    document.getElementById('autoGenSuccessState').classList.add('d-none');
    document.getElementById('autoGenCloseBtn').disabled = false;
    
    var modal = new bootstrap.Modal(document.getElementById('autoGenStoryModal'));
    modal.show();
}

function finishAutoGen() {
    const projectId = document.getElementById('autoGenProjectId').value;
    window.location.href = `/projects/${projectId}`;
}

function appendLog(msg) {
    const log = document.getElementById('autoGenLog');
    const line = document.createElement('div');
    line.textContent = `> ${msg}`;
    log.appendChild(line);
    log.scrollTop = log.scrollHeight;
}

document.getElementById('autoGenStoryForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const projectId = document.getElementById('autoGenProjectId').value;
    const content = document.getElementById('autoGenContent').value;
    const mode = document.querySelector('input[name="genMode"]:checked').value;
    const episode_start = parseInt(document.getElementById('autoGenEpisodeStart').value) || 1;
    const max_characters = parseInt(document.getElementById('autoGenMaxChars').value) || 5;
    const max_scenes = parseInt(document.getElementById('autoGenMaxScenes').value) || 10;
    const single_only = document.getElementById('autoGenSingleOnly').checked;
    
    if (!content.trim()) {
        alert("请输入剧情描述");
        return;
    }
    
    // Switch to Progress State
    document.getElementById('autoGenInputState').classList.add('d-none');
    document.getElementById('autoGenProgressState').classList.remove('d-none');
    document.getElementById('autoGenCloseBtn').disabled = true; // Prevent closing
    
    appendLog("提交任务请求...");
    appendLog(`配置: 模式=${mode}, 起始幕=${episode_start}, 最大角色=${max_characters}, 最大场景=${max_scenes}, 单人模式=${single_only}`);
    
    fetch(`/projects/${projectId}/auto_generate_story`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            content: content, 
            mode: mode,
            episode_start: episode_start,
            max_characters: max_characters,
            max_scenes: max_scenes,
            single_only: single_only
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success' && data.task_id) {
            appendLog("任务已创建 (ID: " + data.task_id + ")");
            startPolling(data.task_id);
        } else {
            alert('提交失败: ' + (data.error || '未知错误'));
            resetModal();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('提交出错，请重试');
        resetModal();
    });
});

function resetModal() {
    document.getElementById('autoGenInputState').classList.remove('d-none');
    document.getElementById('autoGenProgressState').classList.add('d-none');
    document.getElementById('autoGenCloseBtn').disabled = false;
}

function startPolling(taskId) {
    appendLog("开始轮询任务状态...");
    
    if (pollingInterval) clearInterval(pollingInterval);
    
    pollingInterval = setInterval(() => {
        fetch(`/api/tasks/${taskId}`)
        .then(res => res.json())
        .then(task => {
            // Update Progress Bar
            const progressBar = document.getElementById('autoGenProgressBar');
            progressBar.style.width = task.progress + '%';
            
            // Infer logs from progress
            if (task.progress === 10) appendLog("LLM 开始处理剧情...");
            if (task.progress === 30) appendLog("LLM 正在生成角色与场景...");
            if (task.progress === 50) appendLog("LLM 生成完成，解析数据...");
            if (task.progress === 80) appendLog("正在写入数据库...");
            
            if (task.status === 'done') {
                clearInterval(pollingInterval);
                progressBar.style.width = '100%';
                appendLog("任务完成！");
                
                // Show Success State
                setTimeout(() => {
                    document.getElementById('autoGenProgressState').classList.add('d-none');
                    document.getElementById('autoGenSuccessState').classList.remove('d-none');
                    document.getElementById('autoGenCloseBtn').disabled = false;
                    
                    // Parse result
                    try {
                        const result = JSON.parse(task.result_json);
                        let msg = `成功写入 ${result.scenes_created} 个场景，新增 ${result.players_created} 个角色，并提取相关对话`;
                        if (result.players_reused > 0) {
                            msg += `，复用 ${result.players_reused} 个角色`;
                        }
                        
                        document.getElementById('successPlayerCount').textContent = result.players_created + (result.players_reused || 0);
                        document.getElementById('successSceneCount').textContent = result.scenes_created;
                        
                        // Show warning if any
                        if (result.warnings && result.warnings.length > 0) {
                            appendLog("⚠️ 警告: " + result.warnings.join("; "));
                        }
                        
                        // Add detail text
                        const p = document.createElement('p');
                        p.className = "text-secondary small mt-2";
                        p.textContent = msg;
                        
                        // Clear previous content to avoid duplicates
                        const successState = document.getElementById('autoGenSuccessState');
                        // Remove existing 'p' elements to prevent stacking
                        const existingP = successState.querySelector('p.text-secondary.small.mt-2');
                        if (existingP) existingP.remove();
                        
                        successState.appendChild(p);
                        
                    } catch(e) {
                        console.error("Error parsing result", e);
                    }
                }, 500);
            } else if (task.status === 'failed') {
                clearInterval(pollingInterval);
                appendLog("任务失败: " + task.error);
                alert("任务失败: " + task.error);
                document.getElementById('autoGenCloseBtn').disabled = false;
            }
        })
        .catch(err => {
            console.error("Polling error", err);
        });
    }, 1000);
}
</script>
{% endblock %}
